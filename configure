#!/bin/bash

##==============================================================================
##
## Check usage:
##
##==============================================================================

if [ ! -f mak/config.mak ]
then
    echo "$0: must be invoked from the CIMPLE root directory"
    exit 1
fi

##==============================================================================
##
## Determine platform
##
##==============================================================================

if [ "$#" = "1" ]
then
    PLATFORM=$1
else
    if [ "$PEGASUS_PLATFORM" = "" ]
    then
        ARCH=`uname -m`
        OS=`uname -s`
        TOKEN="$OS-$ARCH"


        case "$TOKEN" in

            Linux-i686)
                export PLATFORM=LINUX_IX86_GNU
                ;;

            Linux-x86_64)
                export PLATFORM=LINUX_X86_64_GNU
                ;;

	    Linux-ia64)
		export PLATFORM=LINUX_IA64_GNU
		;;

	    Linux-s390)
		export PLATFORM=LINUX_S390_GNU
		;;

	    Linux-s390x)
		export PLATFORM=LINUX_S390X_GNU
		;;

            Linux-ppc)
                export PLATFORM=LINUX_PPC_GNU
                ;;

            Linux-ppc64)
                export PLATFORM=LINUX_PPC64_GNU
                ;;

            "Darwin-Power Macintosh")
                export PLATFORM=DARWIN_PPC_GNU
                ;;

            Darwin-i386)
                export PLATFORM=DARWIN_IX86_GNU
                ;;

            *)
                echo "Failed to automatically detect platform"
                exit 1
                ;;

        esac
    else
        echo "Deduced platform from \$PEGASUS_PLATFORM environment variable"
        PLATFORM=$PEGASUS_PLATFORM
    fi
fi

##==============================================================================
##
## Check PLATFORM:
##
##==============================================================================

case "$PLATFORM" in

    LINUX_IX86_GNU)
	;;

    LINUX_X86_64_GNU)
	;;

    LINUX_PPC_GNU)
	;;

    LINUX_PPC64_GNU)
	;;

    LINUX_IX86_GNU)
	;;

    DARWIN_IX86_GNU)
	;;

    DARWIN_PPC_GNU)
	;;

    l32)
	PLATFORM=LINUX_IX86_GNU
	;;

    LINUX_IA64_GNU)
	;;

    LINUX_S390_GNU)
	;;

    LINUX_S390X_GNU)
	;;

    l64)
	PLATFORM=LINUX_X86_64_GNU
	;;

    *)
	echo "Unrecognized platform: $PLATFORM"
	exit 1
	;;

esac

##==============================================================================
##
## Create platform makefile and header.
##
##==============================================================================

echo "CIMPLE_PLATFORM=$PLATFORM" > ./mak/platform.mak
echo "#define CIMPLE_PLATFORM_$PLATFORM" > ./src/platform.h
echo "Configured for $PLATFORM"
